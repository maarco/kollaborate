#!/bin/zsh
# Kollaborate CLI - Autonomous Multi-Agent Development Framework
# Usage: kollaborate <command> [options]

set -e

KOLLABORATE_HOME="${KOLLABORATE_HOME:-$(dirname "$(realpath "$0")")}"
KOLLABORATE_VERSION="1.0.0"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

print_banner() {
    echo "${CYAN}"
    echo "╔═══════════════════════════════════════════════════════════════╗"
    echo "║                                                               ║"
    echo "║   ██╗  ██╗ ██████╗ ██╗     ██╗      █████╗ ██████╗            ║"
    echo "║   ██║ ██╔╝██╔═══██╗██║     ██║     ██╔══██╗██╔══██╗           ║"
    echo "║   █████╔╝ ██║   ██║██║     ██║     ███████║██████╔╝           ║"
    echo "║   ██╔═██╗ ██║   ██║██║     ██║     ██╔══██║██╔══██╗           ║"
    echo "║   ██║  ██╗╚██████╔╝███████╗███████╗██║  ██║██████╔╝           ║"
    echo "║   ╚═╝  ╚═╝ ╚═════╝ ╚══════╝╚══════╝╚═╝  ╚═╝╚═════╝            ║"
    echo "║                                                               ║"
    echo "║   Autonomous Multi-Agent Development Framework v${KOLLABORATE_VERSION}         ║"
    echo "║                                                               ║"
    echo "╚═══════════════════════════════════════════════════════════════╝"
    echo "${NC}"
}

print_help() {
    print_banner
    echo "Usage: kollaborate <command> [options]"
    echo ""
    echo "Commands:"
    echo "  ${GREEN}init${NC}              Initialize Kollaborate in current directory"
    echo "  ${GREEN}start${NC} [agents]    Start the agent watcher daemon"
    echo "  ${GREEN}status${NC}            Show current task and agent status"
    echo "  ${GREEN}add${NC} <type> <task> Add a new task to the queue"
    echo "  ${GREEN}help${NC}              Show this help message"
    echo "  ${GREEN}version${NC}           Show version information"
    echo ""
    echo "Task Types:"
    echo "  ${CYAN}feature${NC} (F##)      New functionality"
    echo "  ${CYAN}refactor${NC} (R##)     Code quality, restructuring"
    echo "  ${CYAN}bug${NC} (B##)          Fixes, corrections"
    echo "  ${CYAN}test${NC} (T##)         Test coverage, improvements"
    echo "  ${CYAN}doc${NC} (D##)          Documentation, comments"
    echo "  ${CYAN}perf${NC} (P##)         Performance optimization"
    echo "  ${CYAN}arch${NC} (A##)         Architecture, design"
    echo "  ${CYAN}security${NC} (S##)     Security hardening"
    echo "  ${CYAN}hotfix${NC} (H##)       Urgent production fixes"
    echo "  ${CYAN}migration${NC} (M##)    Database/data migrations"
    echo "  ${CYAN}integration${NC} (I##)  Third-party integrations"
    echo "  ${CYAN}chore${NC} (C##)        Maintenance, dependencies"
    echo "  ${CYAN}experiment${NC} (E##)   POC, spike work"
    echo "  ${CYAN}ux${NC} (U##)           User experience"
    echo "  ${CYAN}validation${NC} (V##)   Data validation, schemas"
    echo "  ${CYAN}workflow${NC} (W##)     CI/CD, automation"
    echo "  ${CYAN}exploration${NC} (X##)  Research tasks"
    echo ""
    echo "Options:"
    echo "  --max-agents <n>      Maximum concurrent task agents (default: 3)"
    echo "  --max-spec-agents <n> Maximum spec generation agents (default: 2)"
    echo "  --project-type <type> Project type hint (node, python, rust, go, etc.)"
    echo ""
    echo "Examples:"
    echo "  kollaborate init                    # Initialize in current directory"
    echo "  kollaborate init --project-type node"
    echo "  kollaborate start 3 2               # Start with 3 task agents, 2 spec agents"
    echo "  kollaborate add feature \"User authentication\" src/auth.js"
    echo "  kollaborate add bug \"Fix memory leak\" src/pool.js"
    echo "  kollaborate add test \"API integration tests\" tests/api.test.js"
    echo ""
}

detect_project_type() {
    local project_dir="$1"

    # Check for various project indicators
    if [[ -f "$project_dir/package.json" ]]; then
        if grep -q "typescript" "$project_dir/package.json" 2>/dev/null; then
            echo "typescript"
        else
            echo "node"
        fi
    elif [[ -f "$project_dir/Cargo.toml" ]]; then
        echo "rust"
    elif [[ -f "$project_dir/go.mod" ]]; then
        echo "go"
    elif [[ -f "$project_dir/requirements.txt" ]] || [[ -f "$project_dir/pyproject.toml" ]] || [[ -f "$project_dir/setup.py" ]]; then
        echo "python"
    elif [[ -f "$project_dir/pom.xml" ]] || [[ -f "$project_dir/build.gradle" ]]; then
        echo "java"
    elif [[ -f "$project_dir/Gemfile" ]]; then
        echo "ruby"
    elif [[ -f "$project_dir/composer.json" ]]; then
        echo "php"
    elif [[ -f "$project_dir/Package.swift" ]]; then
        echo "swift"
    elif [[ -f "$project_dir/pubspec.yaml" ]]; then
        echo "dart"
    else
        echo "generic"
    fi
}

get_build_commands() {
    local project_type="$1"

    case "$project_type" in
        node|typescript)
            cat << 'EOF'
```bash
# Install dependencies
npm install

# Run development server
npm run dev

# Run tests
npm test

# Run linting
npm run lint

# Build for production
npm run build
```
EOF
            ;;
        python)
            cat << 'EOF'
```bash
# Create virtual environment
python -m venv venv
source venv/bin/activate

# Install dependencies
pip install -r requirements.txt

# Run application
python main.py

# Run tests
pytest

# Run linting
flake8 . && black --check .
```
EOF
            ;;
        rust)
            cat << 'EOF'
```bash
# Build project
cargo build

# Run project
cargo run

# Run tests
cargo test

# Check for errors
cargo check

# Format code
cargo fmt

# Run clippy lints
cargo clippy
```
EOF
            ;;
        go)
            cat << 'EOF'
```bash
# Download dependencies
go mod download

# Build project
go build ./...

# Run project
go run .

# Run tests
go test ./...

# Format code
go fmt ./...

# Run linter
golangci-lint run
```
EOF
            ;;
        java)
            cat << 'EOF'
```bash
# Build project (Maven)
mvn clean install

# Run project
mvn spring-boot:run

# Run tests
mvn test

# Build project (Gradle)
./gradlew build

# Run tests (Gradle)
./gradlew test
```
EOF
            ;;
        ruby)
            cat << 'EOF'
```bash
# Install dependencies
bundle install

# Run application
bundle exec ruby main.rb

# Run tests
bundle exec rspec

# Run linting
bundle exec rubocop
```
EOF
            ;;
        php)
            cat << 'EOF'
```bash
# Install dependencies
composer install

# Run development server
php artisan serve

# Run tests
./vendor/bin/phpunit

# Run linting
./vendor/bin/phpcs
```
EOF
            ;;
        swift)
            cat << 'EOF'
```bash
# Build project
swift build

# Run project
swift run

# Run tests
swift test
```
EOF
            ;;
        dart)
            cat << 'EOF'
```bash
# Get dependencies
dart pub get

# Run application
dart run

# Run tests
dart test

# Analyze code
dart analyze
```
EOF
            ;;
        *)
            cat << 'EOF'
```bash
# [Add your build commands here]
# Example:
# make build
# make test
# make run
```
EOF
            ;;
    esac
}

get_default_structure() {
    local project_type="$1"

    case "$project_type" in
        node|typescript)
            echo "src/, tests/, config/"
            ;;
        python)
            echo "src/, tests/, config/"
            ;;
        rust)
            echo "src/, tests/"
            ;;
        go)
            echo "cmd/, internal/, pkg/, tests/"
            ;;
        java)
            echo "src/main/, src/test/, config/"
            ;;
        *)
            echo "src/, tests/, config/"
            ;;
    esac
}

get_task_type_prefix() {
    local task_type="$1"

    case "$task_type" in
        feature|feat|f) echo "F" ;;
        refactor|ref|r) echo "R" ;;
        bug|fix|b) echo "B" ;;
        test|tests|t) echo "T" ;;
        doc|docs|documentation|d) echo "D" ;;
        perf|performance|optimize|p) echo "P" ;;
        arch|architecture|a) echo "A" ;;
        security|sec|s) echo "S" ;;
        hotfix|hot|h) echo "H" ;;
        migration|migrate|m) echo "M" ;;
        integration|integrate|i) echo "I" ;;
        chore|maintenance|c) echo "C" ;;
        experiment|exp|spike|e) echo "E" ;;
        ux|ui|u) echo "U" ;;
        validation|validate|val|v) echo "V" ;;
        workflow|cicd|w) echo "W" ;;
        exploration|explore|research|x) echo "X" ;;
        *) echo "" ;;
    esac
}

get_next_task_number() {
    local task_type_prefix="$1"

    if [[ ! -f "TASK_TRACKING.md" ]]; then
        echo "1"
        return
    fi

    # Find the highest number for this task type
    local max_num=$(grep -oE "${task_type_prefix}[0-9]+" TASK_TRACKING.md 2>/dev/null | sed "s/${task_type_prefix}//" | sort -n | tail -1)

    if [[ -z "$max_num" ]]; then
        echo "1"
    else
        echo "$((max_num + 1))"
    fi
}

get_sample_tasks() {
    local project_type="$1"
    local project_name="$2"

    case "$project_type" in
        node|typescript)
            cat << EOF
NEW: A1 - Initialize package.json with project dependencies and scripts (file: package.json)
NEW: A2 - Create environment configuration module with validation (file: src/config/env.js)
NEW: F1 - Setup application entry point with error handling (file: src/index.js)
NEW: F2 - Implement logging utility with multiple log levels (file: src/utils/logger.js)
NEW: F3 - Create base error classes for standardized error handling (file: src/utils/errors.js)
NEW: T1 - Add unit tests for logger utility (file: tests/utils/logger.test.js)
NEW: D1 - Document API endpoints and usage examples (file: docs/API.md)
EOF
            ;;
        python)
            cat << EOF
NEW: A1 - Initialize pyproject.toml with dependencies and metadata (file: pyproject.toml)
NEW: A2 - Create configuration module with environment variable loading (file: src/config.py)
NEW: F1 - Setup application entry point with argument parsing (file: src/main.py)
NEW: F2 - Implement logging configuration with formatters (file: src/utils/logger.py)
NEW: F3 - Create custom exception classes for error handling (file: src/utils/exceptions.py)
NEW: T1 - Add pytest suite for core modules (file: tests/test_main.py)
NEW: D1 - Document module structure and usage (file: docs/README.md)
EOF
            ;;
        rust)
            cat << EOF
NEW: A1 - Initialize Cargo.toml with dependencies and metadata (file: Cargo.toml)
NEW: A2 - Create configuration module with environment loading (file: src/config.rs)
NEW: F1 - Setup main entry point with error handling (file: src/main.rs)
NEW: F2 - Implement logging with tracing crate (file: src/logging.rs)
NEW: F3 - Create custom error types with thiserror (file: src/error.rs)
NEW: T1 - Add integration tests for core functionality (file: tests/integration_test.rs)
NEW: D1 - Document public API with rustdoc (file: src/lib.rs)
EOF
            ;;
        go)
            cat << EOF
NEW: A1 - Initialize go.mod with module path and dependencies (file: go.mod)
NEW: A2 - Create configuration package with env loading (file: internal/config/config.go)
NEW: F1 - Setup main entry point with graceful shutdown (file: cmd/main.go)
NEW: F2 - Implement structured logging with zerolog (file: internal/logger/logger.go)
NEW: F3 - Create custom error types with stack traces (file: internal/errors/errors.go)
NEW: T1 - Add table-driven tests for config package (file: internal/config/config_test.go)
NEW: D1 - Document package interfaces and examples (file: README.md)
EOF
            ;;
        *)
            cat << EOF
NEW: A1 - Initialize project configuration and dependencies (file: config/setup)
NEW: F1 - Create main application entry point (file: src/main)
NEW: F2 - Implement core business logic module (file: src/core)
NEW: F3 - Setup logging and monitoring utilities (file: src/utils/logger)
NEW: T1 - Create test suite for core functionality (file: tests/core_test)
NEW: D1 - Document project structure and usage (file: docs/README.md)
EOF
            ;;
    esac
}

cmd_init() {
    local project_dir="$(pwd)"
    local project_name="$(basename "$project_dir")"
    local project_type="${PROJECT_TYPE:-$(detect_project_type "$project_dir")}"

    print_banner

    echo "${BLUE}[INIT]${NC} Initializing Kollaborate in: ${CYAN}$project_dir${NC}"
    echo "${BLUE}[INIT]${NC} Detected project type: ${CYAN}$project_type${NC}"
    echo ""

    # Create directory structure
    echo "${YELLOW}[STEP 1/4]${NC} Creating directory structure..."

    if [[ ! -d ".kollaborate" ]]; then
        mkdir -p .kollaborate
        echo "  ${GREEN}+${NC} Created .kollaborate/"
    else
        echo "  ${YELLOW}~${NC} .kollaborate/ already exists"
    fi

    if [[ ! -d "specs" ]]; then
        mkdir -p specs
        echo "  ${GREEN}+${NC} Created specs/"
    else
        echo "  ${YELLOW}~${NC} specs/ already exists"
    fi

    # Copy kollaborate.sh
    echo ""
    echo "${YELLOW}[STEP 2/4]${NC} Installing agent watcher daemon..."

    if [[ -f "$KOLLABORATE_HOME/kollaborate.sh" ]]; then
        cp "$KOLLABORATE_HOME/kollaborate.sh" ".kollaborate/kollaborate.sh"
        chmod +x ".kollaborate/kollaborate.sh"
        echo "  ${GREEN}+${NC} Installed kollaborate.sh"
    else
        echo "  ${RED}!${NC} Error: kollaborate.sh not found at $KOLLABORATE_HOME"
        echo "  ${RED}!${NC} Please ensure KOLLABORATE_HOME is set correctly"
        exit 1
    fi

    # Copy documentation
    echo ""
    echo "${YELLOW}[STEP 3/4]${NC} Installing documentation..."

    if [[ -f "$KOLLABORATE_HOME/kollaborate.md" ]]; then
        cp "$KOLLABORATE_HOME/kollaborate.md" ".kollaborate/kollaborate.md"
        echo "  ${GREEN}+${NC} Installed kollaborate.md"
    fi

    # Create TASK_TRACKING.md
    echo ""
    echo "${YELLOW}[STEP 4/4]${NC} Creating task tracking file..."

    if [[ ! -f "TASK_TRACKING.md" ]]; then
        cat > TASK_TRACKING.md << EOF
# $project_name Development Log

## Current Goal
[Describe your project's primary objective here]

## Build & Development Commands
$(get_build_commands "$project_type")

## Project Structure
$(get_default_structure "$project_type")

## Development Log

$(get_sample_tasks "$project_type" "$project_name")
EOF
        echo "  ${GREEN}+${NC} Created TASK_TRACKING.md with sample tasks"
    else
        echo "  ${YELLOW}~${NC} TASK_TRACKING.md already exists (skipped)"
    fi

    # Add to .gitignore
    echo ""
    if [[ -f ".gitignore" ]]; then
        if ! grep -q ".kollaborate/" ".gitignore" 2>/dev/null; then
            echo "" >> .gitignore
            echo "# Kollaborate" >> .gitignore
            echo ".kollaborate/" >> .gitignore
            echo "  ${GREEN}+${NC} Added .kollaborate/ to .gitignore"
        fi
    fi

    echo ""
    echo "${GREEN}════════════════════════════════════════════════════════════════${NC}"
    echo "${GREEN}  Kollaborate initialized successfully!${NC}"
    echo "${GREEN}════════════════════════════════════════════════════════════════${NC}"
    echo ""
    echo "Next steps:"
    echo "  1. Edit ${CYAN}TASK_TRACKING.md${NC} to define your project goal and tasks"
    echo "  2. Run ${CYAN}kollaborate start${NC} to begin autonomous development"
    echo ""
    echo "Quick commands:"
    echo "  ${CYAN}kollaborate start${NC}        - Start with default settings (3 agents)"
    echo "  ${CYAN}kollaborate start 5 2${NC}    - Start with 5 task agents, 2 spec agents"
    echo "  ${CYAN}kollaborate status${NC}       - Check current progress"
    echo ""
}

cmd_start() {
    local max_agents="${1:-3}"
    local max_spec_agents="${2:-2}"

    if [[ ! -f ".kollaborate/kollaborate.sh" ]]; then
        echo "${RED}[ERROR]${NC} Kollaborate not initialized in this directory"
        echo "Run ${CYAN}kollaborate init${NC} first"
        exit 1
    fi

    if [[ ! -f "TASK_TRACKING.md" ]]; then
        echo "${RED}[ERROR]${NC} TASK_TRACKING.md not found"
        echo "Run ${CYAN}kollaborate init${NC} to create it"
        exit 1
    fi

    print_banner
    echo "${BLUE}[START]${NC} Launching agent watcher daemon..."
    echo "${BLUE}[START]${NC} Max task agents: ${CYAN}$max_agents${NC}"
    echo "${BLUE}[START]${NC} Max spec agents: ${CYAN}$max_spec_agents${NC}"
    echo ""

    exec ./.kollaborate/kollaborate.sh "$max_agents" "$max_spec_agents"
}

cmd_status() {
    if [[ ! -f "TASK_TRACKING.md" ]]; then
        echo "${RED}[ERROR]${NC} TASK_TRACKING.md not found"
        exit 1
    fi

    print_banner

    echo "${BLUE}[STATUS]${NC} Task Overview"
    echo "════════════════════════════════════════"
    echo ""

    local new_count
    local working_count
    local done_count
    local qa_count

    # Count all task types using pattern [FRBDTPASHMIICEUVWX][0-9]+
    new_count=$(grep -c "^NEW: [FRBDTPASHMICEUVWX][0-9]" TASK_TRACKING.md 2>/dev/null) || new_count=0
    working_count=$(grep -c "^WORKING: [FRBDTPASHMICEUVWX][0-9]" TASK_TRACKING.md 2>/dev/null) || working_count=0
    done_count=$(grep -c "^DONE: [FRBDTPASHMICEUVWX][0-9]" TASK_TRACKING.md 2>/dev/null) || done_count=0
    qa_count=$(grep -c "^QA: [FRBDTPASHMICEUVWX][0-9]" TASK_TRACKING.md 2>/dev/null) || qa_count=0

    echo "${YELLOW}Pending:${NC}    $new_count tasks"
    echo "${CYAN}Working:${NC}    $working_count tasks"
    echo "${GREEN}Completed:${NC}  $done_count tasks"
    echo "${BLUE}In QA:${NC}      $qa_count tasks"
    echo ""

    if [[ $working_count -gt 0 ]]; then
        echo "${CYAN}Active Tasks:${NC}"
        grep "^WORKING: [FRBDTPASHMICEUVWX][0-9]" TASK_TRACKING.md | while read -r line; do
            echo "  - $line"
        done
        echo ""
    fi

    if [[ $new_count -gt 0 ]]; then
        echo "${YELLOW}Pending Tasks:${NC}"
        grep "^NEW: [FRBDTPASHMICEUVWX][0-9]" TASK_TRACKING.md | head -5 | while read -r line; do
            echo "  - $line"
        done
        if [[ $new_count -gt 5 ]]; then
            local remaining=$((new_count - 5))
            echo "  ... and $remaining more"
        fi
        echo ""
    fi

    # Check for active agents
    if command -v tlist &> /dev/null; then
        echo "${BLUE}Active Agents:${NC}"
        tlist 2>/dev/null | grep "•" || echo "  No active agents"
        echo ""
    fi
}

cmd_add() {
    local task_type="$1"
    local task_desc="$2"
    local file_path="$3"

    if [[ -z "$task_type" ]] || [[ -z "$task_desc" ]]; then
        echo "${RED}[ERROR]${NC} Task type and description required"
        echo "Usage: kollaborate add <type> \"<description>\" [file]"
        echo ""
        echo "Types: feature, refactor, bug, test, doc, perf, arch, security,"
        echo "       hotfix, migration, integration, chore, experiment, ux,"
        echo "       validation, workflow, exploration"
        echo ""
        echo "Examples:"
        echo "  kollaborate add feature \"User authentication\" src/auth.js"
        echo "  kollaborate add hotfix \"Critical payment bug\" src/payment.js"
        echo "  kollaborate add migration \"Add user roles table\" migrations/"
        exit 1
    fi

    if [[ ! -f "TASK_TRACKING.md" ]]; then
        echo "${RED}[ERROR]${NC} TASK_TRACKING.md not found"
        exit 1
    fi

    # Get task type prefix
    local prefix=$(get_task_type_prefix "$task_type")

    if [[ -z "$prefix" ]]; then
        echo "${RED}[ERROR]${NC} Invalid task type: $task_type"
        echo "Valid types: feature, refactor, bug, test, doc, perf, arch, security,"
        echo "             hotfix, migration, integration, chore, experiment, ux,"
        echo "             validation, workflow, exploration"
        exit 1
    fi

    # Find next number for this task type
    local next_num=$(get_next_task_number "$prefix")
    local task_id="${prefix}${next_num}"

    # Build task line
    local task_line="NEW: $task_id - $task_desc"

    if [[ -n "$file_path" ]]; then
        task_line="$task_line (file: $file_path)"
    fi

    # Add the task
    echo "$task_line" >> TASK_TRACKING.md

    echo "${GREEN}[ADDED]${NC} $task_id - $task_desc"

    if [[ -n "$file_path" ]]; then
        echo "${BLUE}[FILE]${NC}  $file_path"
    fi
}

cmd_version() {
    echo "Kollaborate v${KOLLABORATE_VERSION}"
    echo "Autonomous Multi-Agent Development Framework"
}

# Parse arguments
PROJECT_TYPE=""
MAX_AGENTS=""
MAX_SPEC_AGENTS=""
COMMAND=""
ARGS=()

while [[ $# -gt 0 ]]; do
    case $1 in
        --project-type)
            PROJECT_TYPE="$2"
            shift 2
            ;;
        --max-agents)
            MAX_AGENTS="$2"
            shift 2
            ;;
        --max-spec-agents)
            MAX_SPEC_AGENTS="$2"
            shift 2
            ;;
        init|start|status|add|help|version|-h|--help|-v|--version)
            if [[ -z "$COMMAND" ]]; then
                COMMAND="$1"
            else
                ARGS+=("$1")
            fi
            shift
            ;;
        *)
            ARGS+=("$1")
            shift
            ;;
    esac
done

# Execute command
case "${COMMAND:-help}" in
    init)
        cmd_init
        ;;
    start)
        cmd_start "${MAX_AGENTS:-${ARGS[1]:-3}}" "${MAX_SPEC_AGENTS:-${ARGS[2]:-2}}"
        ;;
    status)
        cmd_status
        ;;
    add)
        cmd_add "${ARGS[1]}" "${ARGS[2]}" "${ARGS[3]}"
        ;;
    version|-v|--version)
        cmd_version
        ;;
    help|-h|--help|*)
        print_help
        ;;
esac
